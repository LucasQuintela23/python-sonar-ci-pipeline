name: SonarCloud Analysis & Test Reports

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-analyze:
    runs-on: ubuntu-latest
    name: Tests, Coverage & SonarCloud Analysis
    
    steps:
      # 1. Checkout do cÃ³digo
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for better analysis

      # 2. Setup Python
      - name: ğŸ Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # 3. Cache de dependÃªncias
      - name: ğŸ’¾ Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. Instalar dependÃªncias
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      # 5. Executar testes multi-ambiente (Staging + Production)
      - name: ğŸš€ Run multi-environment tests
        run: |
          chmod +x run_tests_multi_env.sh
          ./run_tests_multi_env.sh
        continue-on-error: true

      # 6. Gerar relatÃ³rio combinado do Allure
      - name: ğŸ¨ Generate combined Allure report
        if: always()
        run: |
          if [ -d "allure-results-combined" ]; then
            allure generate allure-results-combined \
              -o allure-report-combined \
              --clean
          fi

      # 7. Criar Dashboard HTML multi-ambiente
      - name: ğŸ“Š Create multi-environment dashboard
        if: always()
        run: |
          chmod +x serve_dashboard.sh
          # Apenas gerar o dashboard sem iniciar o servidor
          python3 << 'EOF'
          import shutil
          from pathlib import Path
          
          # Verificar se os diretÃ³rios existem
          allure_combined = Path("allure-report-combined")
          htmlcov_staging = Path("htmlcov-staging")
          htmlcov_prod = Path("htmlcov-production")
          
          if allure_combined.exists():
              print("âœ… Allure combined report found")
          if htmlcov_staging.exists():
              print("âœ… Staging coverage report found")
          if htmlcov_prod.exists():
              print("âœ… Production coverage report found")
          
          # Criar diretÃ³rio para relatÃ³rios finais
          reports_dir = Path("final-reports")
          reports_dir.mkdir(exist_ok=True)
          
          # Copiar os relatÃ³rios para o diretÃ³rio de artefatos
          if allure_combined.exists():
              shutil.copytree(allure_combined, reports_dir / "allure-combined", dirs_exist_ok=True)
              print("ğŸ“‹ Copied Allure combined report")
          
          if htmlcov_staging.exists():
              shutil.copytree(htmlcov_staging, reports_dir / "coverage-staging", dirs_exist_ok=True)
              print("ğŸ“Š Copied staging coverage report")
          
          if htmlcov_prod.exists():
              shutil.copytree(htmlcov_prod, reports_dir / "coverage-production", dirs_exist_ok=True)
              print("ğŸ“Š Copied production coverage report")
          
          # Criar arquivo de resumo
          readme_content = "# Multi-Environment Test Reports\n\n"
          readme_content += "## Test Execution Summary\n"
          readme_content += "- **Staging Tests:** 19\n"
          readme_content += "- **Production Tests:** 19\n"
          readme_content += "- **Total:** 38 tests\n\n"
          readme_content += "## Reports Available\n\n"
          readme_content += "### Allure Report\n"
          readme_content += "- Open: `allure-combined/index.html`\n\n"
          readme_content += "### Coverage Reports\n"
          readme_content += "- Staging Coverage: `coverage-staging/index.html`\n"
          readme_content += "- Production Coverage: `coverage-production/index.html`\n"
          
          with open(reports_dir / "README.md", "w") as f:
              f.write(readme_content)
          print("âœ… Reports directory created with README")
          EOF
        continue-on-error: true

      # 8. Executar testes com relatÃ³rio detalhado (backup)
      - name: ğŸ§ª Run all tests with detailed reports
        run: |
          mkdir -p reports
          pytest tests/ \
            --verbose \
            --tb=short \
            --cov=src \
            --cov-report=xml \
            --cov-report=html:htmlcov \
            --cov-report=term-missing \
            --junit-xml=reports/junit.xml \
            --alluredir=allure-results \
            --maxfail=0 \
            -v
        continue-on-error: true

      # 6. AnÃ¡lise de cobertura
      - name: ğŸ“Š Coverage Analysis
        run: |
          echo "=== COVERAGE REPORT ===" && \
          python -m coverage report -m --precision=2 && \
          echo "" && \
          python -m coverage xml && \
          python -m coverage html

      # 7. Gerar relatÃ³rio Allure
      - name: ğŸ¨ Generate Allure Report
        if: always()
        run: |
          allure generate allure-results \
            -o allure-report \
            --clean

      # 8. Criar sumÃ¡rio de testes em JSON
      - name: ğŸ“ˆ Create test summary
        if: always()
        run: |
          python << 'EOF'
          import json
          import xml.etree.ElementTree as ET
          from pathlib import Path

          # Parse junit.xml
          junit_file = Path("reports/junit.xml")
          if junit_file.exists():
            tree = ET.parse(junit_file)
            root = tree.getroot()
            
            tests = int(root.get('tests', 0))
            failures = int(root.get('failures', 0))
            errors = int(root.get('errors', 0))
            skipped = int(root.get('skipped', 0))
            time = float(root.get('time', 0))
            
            summary = {
              "total_tests": tests,
              "passed": tests - failures - errors - skipped,
              "failed": failures,
              "errors": errors,
              "skipped": skipped,
              "execution_time": f"{time:.2f}s",
              "status": "âœ… PASSED" if failures == 0 and errors == 0 else "âŒ FAILED"
            }
            
            with open("test-summary.json", "w") as f:
              json.dump(summary, f, indent=2)
          EOF

      # 9. Exibir sumÃ¡rio de testes
      - name: ğŸ“‹ Display test summary
        if: always()
        run: |
          if [ -f test-summary.json ]; then
            echo "=== TEST EXECUTION SUMMARY ===" && \
            cat test-summary.json && \
            echo ""
          fi

      # 10. SonarCloud Analysis
      - name: ğŸ” SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

      # 11. Upload Coverage Report
      - name: ğŸ“¤ Upload coverage report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report-html
          path: htmlcov/
          retention-days: 30

      # 12. Upload JUnit XML Report
      - name: ğŸ“¤ Upload test report (JUnit XML)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports-junit
          path: reports/
          retention-days: 30

      # 13. Upload Allure Report
      - name: ğŸ“¤ Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: allure-report-html
          path: allure-report/
          retention-days: 30

      # 13.1 Upload Combined Allure Report (Multi-Environment)
      - name: ğŸ“¤ Upload combined Allure report (multi-env)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: allure-report-combined-multi-env
          path: allure-report-combined/
          retention-days: 30

      # 13.2 Upload Staging Coverage Report
      - name: ğŸ“¤ Upload staging coverage report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report-staging
          path: htmlcov-staging/
          retention-days: 30

      # 13.3 Upload Production Coverage Report
      - name: ğŸ“¤ Upload production coverage report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report-production
          path: htmlcov-production/
          retention-days: 30

      # 13.4 Upload Final Reports Directory
      - name: ğŸ“¤ Upload final reports summary
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: final-reports-multi-env
          path: final-reports/
          retention-days: 30

      # 14. Upload Coverage XML para SonarCloud
      - name: ğŸ“¤ Upload coverage XML
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-xml
          path: coverage.xml
          retention-days: 7

      # 15. Comentar no PR com resultados
      - name: ğŸ’¬ Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summaryText = '## ğŸ“Š Test Execution Report\n\n';
            
            // Add test summary if available
            if (fs.existsSync('test-summary.json')) {
              const summary = JSON.parse(fs.readFileSync('test-summary.json', 'utf8'));
              summaryText += `### Test Results\n`;
              summaryText += `- **Total Tests:** ${summary.total_tests}\n`;
              summaryText += `- **Passed:** âœ… ${summary.passed}\n`;
              summaryText += `- **Failed:** âŒ ${summary.failed}\n`;
              summaryText += `- **Errors:** âš ï¸ ${summary.errors}\n`;
              summaryText += `- **Skipped:** â­ï¸ ${summary.skipped}\n`;
              summaryText += `- **Execution Time:** â±ï¸ ${summary.execution_time}\n`;
              summaryText += `- **Status:** ${summary.status}\n\n`;
            }
            
            summaryText += `### ğŸ“ˆ Available Reports\n`;
            summaryText += `- [ğŸ“Š Coverage Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
            summaryText += `- [ğŸ§ª Test Report (JUnit)](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
            summaryText += `- [ğŸ¨ Allure Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n`;
            
            summaryText += `### ğŸ” SonarCloud Analysis\n`;
            summaryText += `- View full analysis: https://sonarcloud.io/dashboard?id=python-sonar-ci-pipeline\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summaryText
            });
        continue-on-error: true

      # 16. Exibir status final
      - name: âœ¨ Display workflow summary
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸ‰ CI/CD Pipeline Execution Complete ğŸ‰          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Multi-Environment Test Results:"
          echo "  âœ… Staging Environment (19 tests)"
          echo "  âœ… Production Environment (19 tests)"
          echo "  âœ… Combined Reports (38 total)"
          echo ""
          echo "ğŸ“‹ RelatÃ³rios Gerados:"
          echo "  âœ… Multi-Env Coverage Reports (Staging + Production)"
          echo "  âœ… Combined Allure Report (Interactive HTML)"
          echo "  âœ… JUnit Test Report (XML)"
          echo "  âœ… SonarCloud Analysis"
          echo "  âœ… Final Reports Summary"
          echo ""
          echo "ğŸ“¦ Artifacts disponÃ­veis em:"
          echo "  - allure-report-combined-multi-env"
          echo "  - coverage-report-staging"
          echo "  - coverage-report-production"
          echo "  - final-reports-multi-env"
          echo "  - Actions > Latest Run > Artifacts"
          echo ""
          echo "ğŸ” View SonarCloud Results:"
          echo "  - https://sonarcloud.io/dashboard?id=python-sonar-ci-pipeline"
          echo ""
